% List generated by running the following lines in a python compiler
% top_level_dir = 'E:\Dropbox (Dartmouth College)\EC_State_inProcess'
% subdirs = [os.scandir(x) for x in os.scandir(top_level_dir)]
% subdir_names = [[y.path for y in x] for x in subdirs]
close all;
folders = {'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-15_vStr_4p2_light_cells_TT6_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-16_dStr_3p3_light_cells_TT5_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-17_vStr_4p0_light_cells_TT7_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-18_vStr_4p0_light_cells_TT4_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-19_vStr_3p9_light_cells_TT4_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-20_vStr_4p3_light_cells_TT5_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-22_vStr_4p4_light_cells_TT8_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-23_dStr_2p5_light_cells_TT4_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-25_dStr_3p1_light_cells_TT1_TT3_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-26_dStr_3p3_light_cells_TT5_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M16\\M16-2019-02-27_vStr_3p9_light_cells_TT2_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-15_dStr_3p0_light_cells_TT3_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-16_dStr_3p2_light_cells_TT5_lost_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-16_dStr_3p6_light_cells_TT4_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-17_dStr_3p0_light_cells_TT8_TT6', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-18_dStr_3p7_light_cells_TT6_TT5_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-19_dStr_2p5_light_cells_TT5_short_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-20_vStr_3p7_light_cells_TT5_TT6_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-21_vStr_4p2_light_cells_TT7_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-24_dStr_3p6_light_cells_TT1_TT3', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-25_dStr_3p1_light_cells_TT5', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M17\\M17-2019-02-25_dStr_3p9_light_cells_TT1_TT3', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M18\\M18-2019-04-10-dStr_3p8_light_cells_TT4_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M18\\M18-2019-04-11_vStr_4p2_light_cells_TT7_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M18\\M18-2019-04-12_dStr_3p4_light_cells_TT4_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M18\\M18-2019-04-12_dStr_3p8_light_cells_TT7_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M18\\M18-2019-04-13_dStr_3p8_light_cells_TT6_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M18\\M18-2019-04-14_dStr_4p0_light_cells_TT3_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M18\\M18-2019-04-15_dStr_3p3_light_cells_TT8', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M18\\M18-2019-04-15_vStr_4p0_light_cells_TT7_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M19\\M19-2019-04-12_vStr_4p2_light_cells_TT7_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M19\\M19-2019-04-13-vStr_4p7_light_cells_TT2_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M19\\M19-2019-04-13_vStr_4p2_light_cells_TT3_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M19\\M19-2019-04-14_dStr_3p3_light_cells_TT8_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M19\\M19-2019-04-14_vStr_4p2_light_cells_TT5 _min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M19\\M19-2019-04-15_dStr_4p0_light_cells_TT6_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M20\\M20-2019-06-07_dStr_3p8_light_cells_TT6_TT8_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M20\\M20-2019-06-07_dStr_4p6_light_cells_TT6_TT8_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M20\\M20-2019-06-08_vStr_4p2_light_cells_TT7_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M20\\M20-2019-06-09_vStr_4p7_light_cells_TT7_min', 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M20\\M20-2019-06-10_vStr_4p2_light_cells_TT5_TT6_TT7_min'};


sz = [length(folders) 8];
varTypes = ["string", "string", "string", "double", "cell", "cell", "cell", "cell"];
varNames = ["Subject", "Target", "Date", "Depth", "Freqs", "welch_pow", "aperiodic_power", "peak_params"];
psd_table = table('Size',sz,'VariableTypes',varTypes,'VariableNames',varNames);

%%
for i = 1:length(folders)
    cd(folders{i})
    LoadExpKeys;
    depth = ExpKeys.tetrodeDepths;
    target = ExpKeys.target;
    cfg_lfp.fc = {ExpKeys.goodCSC};
    this_lfp = LoadCSC(cfg_lfp);
    
    %temp_edit
    this_lfp = restrict(this_lfp, iv(ExpKeys.timeOnWheel, ExpKeys.timeOffWheel));
    Fs = this_lfp.cfg.hdr{1}.SamplingFrequency;
    wsize = Fs;
    [welch_P, F] = pwelch(this_lfp.data, hanning(wsize), wsize/2, [], Fs); 
    F = (F(F > 0 & F < 200))'; % very important to get rid of the '0' frequency for FOOOF to work, and shape it into 1 x N array
    welch_P = (welch_P(1:length(F)))';
    reshaped_P = reshape(welch_P,1 ,1, length(welch_P));
    % All these parameters are borrowed from "process_fooof.m"
    opt.freq_range = [F(1) F(end)];
    opt.power_line = '60';
    opt.peak_width_limits = [0.5,12];
    opt.max_peaks = 3;
    opt.min_peak_height = 0.3;
    opt.aperiodic_mode = 'knee'; %Check with 'fixed' first
    opt.peak_threshold = 2;
    opt.return_spectrum = 1;
    opt.border_threshold = 1;
    opt.peak_type = 'best'; %There is an error in documenation where it says 'both'
    opt.proximity_threshold = 2;
    opt.guess_weight = 'none';
    opt.thresh_after = 1;
    opt.sort_type = 'param';
    opt.sort_param = 'frequency';
%     opt.sort_bands = {{'delta'}, {'2', '4'}; {'theta'}, {'5', '7'}; ...
%         {'alpha'}, {'8','12'}; {'beta'}, {'15', '29'}; {'gamma1'}, {'30',' 59'};
%         {'gamma2'}, {'60','90'}};
    opt.sort_bands = {{'delta'}, {'2', '5'}; {'theta'}, {'6', '10'}; ...
        {'beta'},{'15', '29'}; {'gamma1'}, {'30',' 55'}; ...
        {'gamma2'}, {'65','90'}};
    % Putting try blocks here because it keeps crashing
    try
        fprintf("\nStarting FOOOF in %s\n", folders{i});
        [fs, fg] = process_fooof('FOOOF_matlab', reshaped_P, F, opt, 1);
    catch
        fprintf("Error in %s\n", folders{i});
        continue
    end
    powspctrm_f = cat(1, fg.ap_fit);
    for k = 1:size(powspctrm_f,1)
        aperiodic_P(k,:) = interp1(fs, powspctrm_f(k,:), F, 'linear', nan);
    end
    psd_table(i,:) = {ExpKeys.subject, ExpKeys.target, ExpKeys.date, ...
        ExpKeys.tetrodeDepths, {F}, {welch_P}, {aperiodic_P}, {fg.peak_params}};
    clear aperiodic_P
end

%% Plot depth sorted PSDs for each mouse
subjects = {'M16', 'M17', 'M18', 'M19', 'M20'};
for iS = 1:length(subjects)
    close;
    this_sub = strcmp(psd_table.Subject,subjects{iS});
    ncols = 3;
    nrows = ceil(sum(this_sub)/ncols);
    this_table = psd_table(this_sub,:);
    this_table = sortrows(this_table, 'Depth');
    fig = figure('WindowState', 'maximized');
    for iP = 1:height(this_table)
        subplot(nrows, ncols, iP);
        this_row = this_table(iP,:);
        plot(this_row.Freqs{1}, 10*log10(this_row.welch_pow{1}))
        hold on;
        plot(this_row.Freqs{1}, 10*log10(this_row.aperiodic_power{1}))
        for iR = 1:size(this_row.peak_params{1})
            xline(this_row.peak_params{1}(iR,1), 'black');
        end
        xlim([0 120])
        title_str = sprintf("Depth: %.2f mm\t Target: %s \t Date: %s", ...
            this_row.Depth, this_row.Target, this_row.Date);
        title(title_str, 'Interpreter', 'none');
    end
    suptitle(subjects{iS});
    print(fig, '-dpng', '-r300', strcat(subjects{iS}, '_All_PSD'))
end
