folders = {'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-15_vStr_4p2_light_cells_TT6_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-16_dStr_3p3_light_cells_TT5_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-17_vStr_4p0_light_cells_TT7_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-18_vStr_4p0_light_cells_TT4_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-19_vStr_3p9_light_cells_TT4_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-20_vStr_4p3_light_cells_TT5_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-22_vStr_4p4_light_cells_TT8_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-23_dStr_2p5_light_cells_TT4_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-25_dStr_3p1_light_cells_TT1_TT3_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-26_dStr_3p3_light_cells_TT5_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M016\\M016-2019-02-27_vStr_3p9_light_cells_TT2_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-15_dStr_3p0_light_cells_TT3_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-16_dStr_3p2_light_cells_TT5_lost_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-16_dStr_3p6_light_cells_TT4_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-17_dStr_3p0_light_cells_TT8_TT6', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-18_dStr_3p7_light_cells_TT6_TT5_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-19_dStr_2p5_light_cells_TT5_short_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-20_vStr_3p7_light_cells_TT5_TT6_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-21_vStr_4p2_light_cells_TT7_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-24_dStr_3p6_light_cells_TT1_TT3', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-25_dStr_3p1_light_cells_TT5', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M017\\M017-2019-02-25_dStr_3p9_light_cells_TT1_TT3', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M018\\M018-2019-04-10-dStr_3p8_light_cells_TT4_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M018\\M018-2019-04-11_vStr_4p2_light_cells_TT7_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M018\\M018-2019-04-12_dStr_3p4_light_cells_TT4_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M018\\M018-2019-04-12_dStr_3p8_light_cells_TT7_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M018\\M018-2019-04-13_dStr_3p8_light_cells_TT6_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M018\\M018-2019-04-14_dStr_4p0_light_cells_TT3_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M018\\M018-2019-04-15_dStr_3p3_light_cells_TT8', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M018\\M018-2019-04-15_vStr_4p0_light_cells_TT7_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M019\\M019-2019-04-12_vStr_4p2_light_cells_TT7_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M019\\M019-2019-04-13-vStr_4p7_light_cells_TT2_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M019\\M019-2019-04-13_vStr_4p2_light_cells_TT3_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M019\\M019-2019-04-14_dStr_3p3_light_cells_TT8_min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M019\\M019-2019-04-14_vStr_4p2_light_cells_TT5 _min', ...
 'E:\\Dropbox (Dartmouth College)\\EC_State_inProcess\\M019\\M019-2019-04-15_dStr_4p0_light_cells_TT6_min', ...
 'E:\Dropbox (Dartmouth College)\EC_State_inProcess\M020\M020-2019-06-07_dStr_3p8_light_cells_TT6_TT8_min', ...
 'E:\Dropbox (Dartmouth College)\EC_State_inProcess\M020\M020-2019-06-07_dStr_4p6_light_cells_TT6_TT8_min', ...
 'E:\Dropbox (Dartmouth College)\EC_State_inProcess\M020\M020-2019-06-08_vStr_4p2_light_cells_TT7_min', ...
 'E:\Dropbox (Dartmouth College)\EC_State_inProcess\M020\M020-2019-06-09_vStr_4p7_light_cells_TT7_min', ...
 'E:\Dropbox (Dartmouth College)\EC_State_inProcess\M020\M020-2019-06-10_vStr_4p2_light_cells_TT5_TT6_TT7_min'};


for i = 2:length(folders)
    if i == 13
        continue;
    end
    cd(folders{i});
    prefix = split(folders{i}, '\');
    prefix = split(prefix{end}, '_');
    prefix = prefix{1};

    LoadExpKeys;
    evs = LoadEvents([]);

    % Convert values to match Manish Data
    if ExpKeys.tetrodeDepths <= 3.5
        ExpKeys.target = 'dStr';
    else
        ExpKeys.target = 'vStr';
    end
    if strcmp(ExpKeys.hemisphere, 'L')
        ExpKeys.hemisphere = 'Left';
    elseif strcmp(ExpKeys.hemisphere, 'R')
        ExpKeys.hemisphere = 'Right';
    end

    % Open new ExpKeys file
    fid = fopen([strrep(prefix,'-','_') '_NewExp.m'], 'w');

    % Open diagnosis file
    eid= fopen('ExpKeyDiagnosis.txt', 'w');

    % Mouse info
    fprintf(fid, 'ExpKeys.species = \"mouse\";\n');
    fprintf(fid, 'ExpKeys.genetics = \"PV-Cre:Ai-32\";\n');
    fprintf(fid, 'ExpKeys.subject_id = \"%s\";\n', strrep(ExpKeys.subject,'M', 'M0'));
    fprintf(fid, 'ExpKeys.hemisphere = \"%s\";\n', ExpKeys.hemisphere);
    fprintf(fid, 'ExpKeys.experimenter = \"%s\";\n', ExpKeys.experimenter);
    fprintf(fid, 'ExpKeys.weight = 0; %%in grams;\n');
    fprintf(fid, 'ExpKeys.probeDepth = %.2f; %%in mm;\n', ExpKeys.tetrodeDepths);
    fprintf(fid, 'ExpKeys.date = \"%s\";\n', ExpKeys.date);
    fprintf(fid, 'ExpKeys.target = \"%s\";\n', ExpKeys.target);

    % Light Soure and Probe info
    fprintf(fid, '\nExpKeys.light_source = "Shanghai Dream LASER";\n');
    fprintf(fid, 'ExpKeys.wavelength = 473; %%in nm;\n');
    fprintf(fid, 'ExpKeys.probeType = \"%s\";\n', ['NeuroNexus ', ExpKeys.probe]);
    fprintf(fid, 'ExpKeys.probeID = \"\";\n');
    fprintf(fid, 'ExpKeys.HSID = \"\";\n');
    fprintf(fid, 'ExpKeys.patch_cord_dia = %d; %%in microns\n', ExpKeys.fibre_cable);
    fprintf(fid, 'ExpKeys.patch_cord_NA = %.2f;\n', ExpKeys.fibre_NA);
    fprintf(fid, 'ExpKeys.probe_fiber_dia = %d;\n', ExpKeys.fibre_probe);
    fprintf(fid, 'ExpKeys.probe_fiber_NA = 0;\n');
    fprintf(fid, 'ExpKeys.max_power = 0; %%in mW\n');
    fprintf(fid, 'ExpKeys.output_power_calib = []; %%in mW\n');
    fprintf(fid, 'ExpKeys.dial_values_calib = [];\n');
    fprintf(fid, 'ExpKeys.dial_value = 0;\n');
    fprintf(fid, 'ExpKeys.light_power = 0;\n');

    % Stim parameters
    fprintf(fid, '\nExpKeys.stim_mode = \"%s\"; %% if fixed then just used ISI, if variable then ISI is between 0-1500ms\n', ExpKeys.stim_mode);  
    fprintf(fid, 'ExpKeys.ISI = 2; %%in seconds\n');
    fprintf(fid, 'ExpKeys.short_stim_pulse_width = 0.001; %%in seconds\n');
    fprintf(fid, 'ExpKeys.long_stim_pulse_width = 0.01; %%in seconds\n');

    % NLX Digital codes
    fprintf(fid, '\nExpKeys.pre_trial_stim_on = \"%s\";\n', ExpKeys.short_laser_on);
    fprintf(fid, 'ExpKeys.trial_stim_on       = \"%s\";\n', ExpKeys.laser_on);
    fprintf(fid, 'ExpKeys.post_trial_stim_on  = \"%s\";\n', ExpKeys.short_laser_on);
    fprintf(fid, 'ExpKeys.long_stim_on        = \"%s\";\n', ExpKeys.wide_laser_on);
    fprintf(fid, 'ExpKeys.stim_off            = \"%s\";\n', ExpKeys.event_off);

    % Start Stop Times
    
    short_on = evs.t{strcmp(evs.label, ExpKeys.short_laser_on)};
    pre_short_on = short_on(short_on <= ExpKeys.timeOnWheel);
    post_short_on = short_on(short_on >= ExpKeys.timeOffWheel);
    trial_on = evs.t{strcmp(evs.label, ExpKeys.laser_on)};
    trial_on = trial_on((trial_on >= ExpKeys.timeOnWheel) & (trial_on <= ExpKeys.timeOffWheel));
    long_on = evs.t{strcmp(evs.label, ExpKeys.wide_laser_on)};
    long_on = long_on(long_on > ExpKeys.timeOffWheel);

    cfg = []; cfg.fc = {ExpKeys.goodCSC};
    csc = LoadCSC(cfg);
    long_on = long_on(long_on < csc.tvec(end)); 

    % TODO add condition to get rid of stuff that is not within the last CSC
    % block

    fprintf(fid, '\nExpKeys.pre_baseline_times = [%.2f, %.2f];\n', ExpKeys.PreRecord(1), ExpKeys.PreRecord(2));
    
    % Report if pre-record times have any stim
    if sum(short_on < ExpKeys.PreRecord(2)) + sum(trial_on < ExpKeys.PreRecord(2)) + sum(long_on < ExpKeys.PreRecord(2)) > 0
        fprintf(eid, '%s has stim in pre-record epoch.\n', prefix);
    end

    fprintf(fid, 'ExpKeys.pre_stim_times         = [%.2f, %.2f];\n', ExpKeys.Hundred_Stims(1), ExpKeys.Hundred_Stims(2));
    % Report number of pre-stim
    fprintf(eid, '%s has %d pre-stims\n', prefix, length(pre_short_on));
    
    fprintf(fid, 'ExpKeys.stim_times             = [%.2f, %.2f];\n', ExpKeys.timeOnWheel, ExpKeys.timeOffWheel);
    % Report number of trial-stim
    fprintf(eid, '%s has %d number of trial-stims\n', prefix, length(trial_on));
    
    fprintf(fid, 'ExpKeys.post_baseline_times    = [%.2f, %.2f];\n', ExpKeys.PostRecord(1), ExpKeys.PostRecord(2));
    % Report if post-record times has any stim
    if sum(post_short_on < ExpKeys.PostRecord(2)) + sum(long_on < ExpKeys.PostRecord(2)) > 0
        fprintf(eid, '%s has stim in post-record epoch.\n', prefix);
    end

    fprintf(fid, 'ExpKeys.post_stim_times        = [%.2f, %.2f];\n', post_short_on(1)-0.5, post_short_on(end)+0.5);
    % Report number of post-stim
    fprintf(eid, '%s has %d post-stims\n', prefix, length(post_short_on));

    fprintf(fid, 'ExpKeys.long_stim_times        = [%.2f, %.2f];\n', long_on(1)-0.5, long_on(end)+0.5);
    % Report number of long-stim
    fprintf(eid, '%s has %d long-stims\n', prefix, length(long_on));

    fprintf(fid, 'ExpKeys.recording_times        = [%.2f, %.2f];\n', ExpKeys.PreRecord(1), long_on(end)+0.5);

    fprintf(fid, '\nExpKeys.notes = \"\";\n');
    fprintf(fid, 'ExpKeys.isSpikeSorted = \"Yes\";\n');
    fprintf(fid, 'ExpKeys.isReferenceRecordedSeparately = \"No\";\n');
    fprintf(fid, 'ExpKeys.hasSpecialStim = \"No\";\n');
    fprintf(fid, 'ExpKeys.goodLFP = {\"%s\"};\n',ExpKeys.goodCSC);
    fprintf(fid, 'ExpKeys.needsInterpolation = true;');
    fprintf(fid, 'ExpKeys.artifact_window = 0; %%in seconds\n');
    fprintf(fid, 'ExpKeys.goodTrials = [];\n');
    fprintf(fid, 'ExpKeys.goodCell = {};\n');

    fclose(fid);
    fclose(eid);
    clear cfg csc short_on pre_short_on post_short_on trial_on long_on prefix
   
end
